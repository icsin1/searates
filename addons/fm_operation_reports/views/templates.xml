<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <template id="customer_vendor_statement_main">
        <t t-call="web.html_container">
            <t t-set="report" t-value="docs.env[report_model].browse(int(report_id))"/>
            <t t-if="options.get('folded')">
                <t t-call="fm_operation_reports.customer_vendor_statement_line_summary"/>
            </t>
            <t t-else="">
                <t t-foreach="options.get('partner_ids') or report.get_partners(options)" t-as="partner_id">
                    <t t-set="o" t-value="env['res.partner'].browse(partner_id)"/>
                    <t t-call="fm_operation_reports.customer_vendor_statement_line"/>
                </t>
            </t>
        </t>
    </template>
    <template id="customer_vendor_statement_line_summary">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <t t-set="report" t-value="docs.env[report_model].browse(int(report_id))"/>
                <div class="bg-200 p-2">
                    <h2 class="text-center">
                        <t t-out="report.get_title()"/>
                    </h2>
                    <h5 t-out="options['date']['string']"/>
                    <strong class="h6 py-2">Company:
                        <span t-out="options['company']"/>
                    </strong>
                    <br/>
                    <strong class="h6 py-2">Period:
                        <span t-out="options['date']['date_from']"/>
                        to
                        <span t-out="options['date']['date_to']"/>
                    </strong>
                    <br/>
                </div>
                <table width="100%" class="table table-bg-white table-sm table-bordered">
                    <t t-set="header_items" t-value="options.get('headers')"/>
                    <thead>
                        <tr class="text-right bg-300">
                            <th></th>
                            <t t-foreach="header_items" t-as="title">
                                <th class="text-right">
                                    <span t-out="title"/>
                                </th>
                            </t>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-if="report._name != 'account.finance.report'">
                            <t t-set="section_lines" t-value="report._get_sections(options)"/>
                        </t>
                        <t t-foreach="section_lines" t-as="line">
                            <tr t-attf-class="border_level_{{line['level']}}">
                                <td>
                                    <strong t-out="line['title']"/>
                                </td>
                                <td t-foreach="line['values']" t-as="line_key" class="text-right">
                                    <t t-if="isinstance(line['values'][line_key], tuple)">
                                        <strong t-out="tuple(line['values'][line_key])[1]"/>
                                    </t>
                                    <t t-else="">
                                        <strong t-out="line['values'][line_key]"/>
                                    </t>
                                </td>
                            </tr>

                        </t>
                    </tbody>
                </table>
            </t>
        </t>
    </template>

    <template id="customer_vendor_statement_line">
        <t t-if="not o" t-set="o" t-value="doc"/>

        <t t-if="not company">
            <t t-if="company_id">
                <t t-set="company" t-value="company_id"/>
            </t>
            <t t-elif="o and 'company_id' in o and o.company_id.sudo()">
                <t t-set="company" t-value="o.company_id.sudo()"/>
            </t>
            <t t-else="else">
                <t t-set="company" t-value="res_company"/>
            </t>
        </t>

        <t t-call="web.external_layout">
            <div class="page pt-0" style="page-break-inside: avoid;">
                <div>
                    <t t-call="web.address_layout"/>
                    <div class="row pt-4">
                        <div class="col-2"></div>
                        <div class="col-8">
                            <div class="h4 font-weight-bold text-center pt-4">
                                <u>STATEMENT OF ACCOUNT</u>
                            </div>
                            <div class="h6 font-weight-bold text-center">
                                From <t t-esc="options.get('date').get('date_from')" t-options="{'widget': 'date'}"/> To <t t-esc="options.get('date').get('date_to')" t-options="{'widget': 'date'}"/>
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="text-right">
                                Date: <t t-esc="datetime.datetime.today().date()" t-options="{'widget': 'date'}"/>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <t t-set="report_type" t-value="o and o.env.context.get('report_mode')"/>
                            <h6>
                                <strong><t t-if="report_type == 'vendor'">Vendor: </t><t t-else="">Customer: </t></strong>
                                <address t-esc="o" t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/>
                            </h6>
                        </div>
                        <div class="col-6 text-right">
                            <h6>CURRENCY: <t t-esc="company.currency_id.display_name"/></h6>
                        </div>
                    </div>
                    <table class="table table-sm o_main_table" style="color: #000000;">
                        <t t-set="header_items" t-value="report._get_column_headers_on_report(options)"/>
                        <thead>
                            <tr class="text-center bg-300">
                                <th>Invoice No.</th>
                                <t t-foreach="header_items" t-as="title">
                                    <th class="text-center">
                                        <span t-out="title"/>
                                    </th>
                                </t>
                            </tr>
                        </thead>
                        <tbody style="color: #000000;">
                            <t t-set="opening_balance" t-value="report._get_opening_balance_on_report(options, o.id)"/>
                            <t t-set="closing_balance" t-value="report._get_total_on_report(options, o.id, 'balance')"/>
                            <tr>
                                <td>OPENING BALANCE</td>
                                <td t-foreach="range(len(header_items)-3)" t-as="td_line">
                                </td>
                                <td class="text-right">
                                    <t t-if="opening_balance &gt;= 0">
                                        <t t-esc="report._format_currency(abs(opening_balance))" />
                                    </t>
                                </td>
                                <td class="text-right">
                                    <t t-if="opening_balance &lt; 0">
                                        <t t-esc="report._format_currency(abs(opening_balance))" />
                                    </t>
                                </td>
                                <td class="text-right">
                                    <t t-esc="report._format_currency(opening_balance)"/>
                                </td>
                            </tr>
                            <tr t-foreach="report.get_account_report_section_data(line, options, o.id)" t-as="detail_line">
                                <td><t t-out="detail_line['title']"/></td>
                                <t t-set="pop_extra_col" t-value="detail_line['values'].pop('Opening Balance')"/>
                                <td t-foreach="detail_line['values']" t-as="line_key" class="text-right">
                                    <t t-if="isinstance(detail_line['values'][line_key], tuple)">
                                        <t t-out="tuple(detail_line['values'][line_key])[1]"/>
                                    </t>
                                    <t t-else="">
                                        <t t-out="detail_line['values'][line_key]"/>
                                    </t>
                                </td>
                            </tr>
                            <tr>
                                <t t-set="debit" t-value="report._get_total_on_report(options, o.id, 'debit')"/>
                                <t t-set="credit" t-value="report._get_total_on_report(options, o.id, 'credit')"/>
                                <t t-set="total_balance" t-value="opening_balance + closing_balance"/>
                                <td class="font-weight-bold border-top border-dark">
                                    <div><t t-out="'TOTAL'"/></div>
                                </td>
                                <td t-att-colspan="len(header_items)-3" class="border-top border-dark">
                                    <span t-esc="o.currency_id.with_context(lang=o.lang).amount_to_text(total_balance)"/>
                                </td>
                                <td class="text-right border-top border-dark">
                                    <t t-if="opening_balance &gt; 0">
                                        <t t-out="report._format_currency(debit + abs(opening_balance))"/>
                                    </t>
                                    <t t-else="">
                                        <t t-out="report._format_currency(debit)"/>
                                    </t>
                                </td>
                                <td class="text-right border-top border-dark">
                                    <t t-if="opening_balance &lt; 0">
                                        <t t-out="report._format_currency(credit + abs(opening_balance))"/>
                                    </t>
                                    <t t-else="">
                                        <t t-out="report._format_currency(credit)"/>
                                    </t>
                                </td>
                                <td class="text-right font-weight-bold o_total border-top border-dark">
                                    <t t-esc="report._format_currency(total_balance)"/>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="row pt-4">
                        <div class="col-12 pt-4 text-right">
                            <div class="border-top d-inline-block w-25">
                                <h5>
                                    <t t-esc="company.display_name"/>
                                </h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>
