<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <template id="service_jobs_portal_layout" name="Service Jobs Portal Layout" inherit_id="portal.portal_breadcrumbs">
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li t-if="page_name == 'service_jobs_shipment' or service_job" t-attf-class="breadcrumb-item active">
                <a t-if="service_job" t-attf-href="/dashboard/service_jobs_shipment?{{ keep_query() }}">Service Jobs</a>
                <t t-else="">Service Jobs</t>
            </li>
            <li t-if="service_job" class="breadcrumb-item active">
                <t t-esc="service_job.booking_nomination_no"/>
            </li>
        </xpath>
    </template>

    <template id="portal_my_home_service_jobs_shipment" name="Show Service Jobs Shipment" customize_show="True" inherit_id="portal.portal_my_home" priority="32">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="title">Service Jobs</t>
                <t t-set="url" t-value="'/dashboard/service_jobs_shipment'"/>
                <t t-set="placeholder_count" t-value="'service_jobs_shipment_count'"/>
            </t>
        </xpath>
    </template>

    <template id="dialog_box">
        <div class="modal fade" t-att-id="dialog_id" tabindex="-1" role="dialog" aria-labelledby="UploadDocument" aria-hidden="true">
            <form action="/upload/service_job/document" method="post" enctype="multipart/form-data" name="upload_document">
                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content text-center">
                        <div class="modal-header">
                            <h5 class="modal-title" id="UploadDocument">Upload Document</h5>
                            <button type="button" class="close" data-dismiss="modal"
                                    aria-label="Close">
                                <span aria-hidden="true">Ã—</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group col-lg-12">
                                <label class="form-label">
                                    <strong>Document Name:</strong>
                                </label>
                                <input type="hidden" name="shipment_id" t-att-value="service_job.id"/>
                                <input type="hidden" name="selected_document_id" t-att-value="selected_document and selected_document.id"/>
                                <input type="text" class="o_input form-control" t-att-value="selected_document and selected_document.name" name="name" required="required"/>
                                <br/>
                                <label class="form-label">
                                    <strong>Document Type:</strong>
                                </label>
                                <select class="form-group form-control" name="document_id" required="required">
                                    <option value=""/>
                                    <t t-foreach="document_type_ids" t-as="document">
                                        <option t-att-data-id="document.id" t-att-selected="selected_document and selected_document.document_type_id.id == document.id" t-att-value="document.id">
                                            <t t-esc="document.name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>
                            <div class="form-group col-lg-12">
                                <label for="file_name" class="control-label">
                                    <strong>Upload File:</strong>
                                </label>
                                <input type="file"  name="file_name" class="form-control h-100" id="uploadFile" t-att-required="not selected_document"/>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary"
                                    data-dismiss="modal">
                                Close
                            </button>
                            <button type="submit" t-attf-href="/upload/service_jobs/document" class="btn btn-primary">
                                <t t-esc="selected_document and 'Update' or 'Upload Document'"/>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </template>

    <template id="portal_my_service_jobs_shipment" name="My Service Jobs">
        <t t-call="ics_customer_portal_base.ics_customer_portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <t t-call="ics_customer_portal_base.ics_customer_portal_searchbar">
                <t t-set="title">Service Jobs</t>
            </t>
            <t t-if="not service_jobs">
                <p>There are currently no Service Jobs for your account.</p>
            </t>
            <t t-if="service_jobs" t-call="portal.portal_table">
                <t t-foreach="service_jobs" t-as="each_job">
                    <div class="container my-2">
                        <div class="card">
                            <div class="card-header alert-primary" data-toggle="collapse" t-att-data-target="'#collapseCard' + str(each_job.id)">
                                <h5 class="mb-0">
                                    <t t-if="each_job.transport_mode_id.code == 'SEA'"><i class="fa fa-ship" aria-label="ship"></i></t>
                                    <t t-if="each_job.transport_mode_id.code == 'AIR'"><i class="fa fa-plane" aria-label="plane"></i></t>
                                    <t t-if="each_job.transport_mode_id.code == 'ROA'"><i class="fa fa-road" aria-label="road"></i></t>
                                    Shipment Number: <span t-field="each_job.name"></span>
                                </h5>
                            </div>
                            <div t-att-id="'collapseCard' + str(each_job.id)" class="collapse">
                                <t t-set="events" t-value="each_job.event_ids.filtered(lambda event: event.public_visible)"/>
                                <div class="card-body">
                                    <div class="row border-top mt-2 pt-2 justify-content-between flex-nowrap overflow-auto">
                                        <t t-foreach="events" t-as="event">
                                            <div class="border m-4 p-4 w-25 text-center">
                                                <h4 t-field="event.location"/>
                                                <div t-field="event.estimated_datetime"/>
                                            </div>
                                        </t>
                                    </div>
                                    <div t-if="events" class="row">
                                        <ul class="timeline_horizon">
                                            <t t-foreach="events"
                                                t-as="event">
                                                <t t-if="event.actual_datetime">
                                                    <t t-set="actual_date" t-value="event.actual_datetime.strftime('%d %b, %Y')"/>
                                                </t>
                                                <t t-else="">
                                                    <t t-set="actual_date" t-value=""/>
                                                </t>
                                                <li t-att-data-value="actual_date" t-att-data-text="event.event_type_id.name"/>
                                            </t>
                                        </ul>
                                    </div>
                                </div>
                                <div class="row border-top m-2 p-2">
                                    <div class="col-6">
                                        <div>Shipment Date: <span t-field="each_job.date"/></div>
                                        <div>Consignee: <span t-field="each_job.consignee_id"/></div>
                                    </div>
                                    <div class="col-6">
                                        <div>Shipper: <span t-field="each_job.company_id"/></div>
                                    </div>
                                </div>
                                <div class="row border-top mt-2 pt-2 pb-2">
                                    <div class="col-12 text-center">
                                        <a class="btn btn-primary" t-att-href="each_job.get_ff_portal_url()">View Service Job
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </t>
                </t>
            </t>
    </template>

    <template id="service_jobs_shipment_portal_template" name="Service Jobs Portal" inherit_id="ics_customer_portal_base.ics_customer_portal_sidebar"
              primary="True">
        <xpath expr="//div[hasclass('o_portal_sidebar')]" position="inside">
            <t t-set="o_portal_fullwidth_alert" groups="base.group_user">
                <t t-call="portal.portal_back_in_edit_mode">
                    <t t-set="backend_url"
                       t-value="'/web#model=%s&amp;id=%s&amp;action=%s&amp;view_type=form' % (service_job._name, service_job.id, action.id)"/>
                </t>
            </t>

            <div class="row mt16 o_portal_quote_sidebar">
                <div id="service_job_content" class="col-12 col-lg justify-content-end">
                    <!-- main content -->
                    <div t-attf-class="card #{'pb-5' if report_type == 'html' else ''}" id="portal_service_jobs_content">
                        <div t-call="ics_customer_portal_shipment_jobs.service_jobs_portal_content"/>
                    </div>

                    <!-- chatter -->
                    <div id="service_jobs_communication" class="mt-4">
                        <h2>History</h2>
                        <t t-call="portal.message_thread">
                            <t t-set="object" t-value="service_job"/>
                        </t>
                    </div>
                </div>
            </div>
        </xpath>
    </template>

    <template id="service_jobs_portal_content" name="Service Job Portal Content">
        <div id="introduction" t-attf-class="pb-2 pt-3 #{'card-header bg-white' if report_type == 'html' else ''}">
            <h2 class="my-0">
                Service Job Number
                <em t-esc="service_job.booking_nomination_no"/>
            </h2>
        </div>
        <div t-attf-class="#{'card-body' if report_type == 'html' else ''}">
            <div id="informations">
                <div class="row" id="service_job_status">
                    <div class="mb-3 col-6">
                        <strong>Status:</strong>
                        <span t-field="service_job.state"/>
                    </div>
                </div>
                <div class="row" id="service_job_origin_to_destination">
                    <div class="mb-6 col-10">
                        <t t-if="service_job.transport_mode_id.code == 'SEA'"><i class="fa fa-ship" aria-label="ship"></i></t>
                        <t t-if="service_job.transport_mode_id.code == 'AIR'"><i class="fa fa-plane" aria-label="plane"></i></t>
                        <t t-if="service_job.transport_mode_id.code == 'ROA'"><i class="fa fa-road" aria-label="road"></i></t>
                        <img class="rounded-circle" style="height:20px; width:20px;"
                             t-att-src="service_job.origin_un_location_id.country_id.image_url"/>
                        <span t-field="service_job.origin_un_location_id.name"/>,&amp;nbsp;
                        <span t-field="service_job.origin_port_un_location_id.name"
                              t-if="service_job.origin_port_un_location_id"/>
                        <i class="fa fa-long-arrow-right"/>
                        <img class="rounded-circle" style="height:20px; width:20px;"
                             t-att-src="service_job.destination_un_location_id.country_id.image_url"/>
                        <span t-field="service_job.destination_un_location_id"/>,&amp;nbsp;
                        <span t-field="service_job.destination_port_un_location_id.name"
                              t-if="service_job.destination_port_un_location_id"/>
                    </div>
                </div>
                <div class="row">
                    <t t-if="service_job.event_ids">
                        <ul class="timeline_horizon">
                            <t t-foreach="service_job.event_ids.filtered(lambda event: event.public_visible)"
                               t-as="event">
                                <t t-if="event.actual_datetime">
                                    <t t-set="actual_date" t-value="event.actual_datetime.strftime('%d %b, %Y')"/>
                                </t>
                                <t t-else="">
                                    <t t-set="actual_date" t-value=""/>
                                </t>
                                <li t-att-data-value="actual_date" t-att-data-text="event.event_type_id.name"/>
                            </t>
                        </ul>
                    </t>
                </div>
<!--                style="position: relative;"-->
                <div class="portal_navbar" >
                    <ul class="nav nav-tabs o_wslides_lesson_nav" role="tablist">
                        <li class="nav-item">
                            <a href="#documents" aria-controls="documents" aria-selected="false"
                               class="nav-link active" role="tab" data-toggle="tab">
                                Documents
                            </a>
                        </li>
                        <li class="nav-item d-none">
                            <a href="#cargo_details" aria-controls="cargo_details" aria-selected="false"
                               class="nav-link" role="tab" data-toggle="tab">
                                Cargo Details
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content" id="myTabContent">
                        <div role="tabpanel" class="tab-pane fade show active" id="documents">
                            <div t-if="error" class="col-md-12 py-2 from-group">
                                <div class="alert alert-danger m-0" role="alert">
                                    Invalid file type
                                    <br/>
                                    <small>
                                        Upload from the allowed Format docx, doc, txt, odt, xlsx, xls, jpeg, png, pdf
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-3 py-2 pl-md-0 pr-md-2 from-group">
                                <button type="button" class="btn btn-primary" data-toggle="modal"
                                        data-target="#upload_document_modal">
                                    Upload Document
                                </button>
                                <t t-call="ics_customer_portal_shipment_jobs.dialog_box">
                                    <t t-set="dialog_id" t-value="'upload_document_modal'"/>
                                </t>
                            </div>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th scope="col">Description</th>
                                        <th scope="col">Document Type</th>
                                        <th scope="col">Attachment</th>
                                        <th scope="col">Edit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="service_job.document_ids.filtered(lambda doc: doc.is_publish)" t-as="document">
                                        <tr>
                                            <th scope="row">
                                                <t t-esc="document.name"/>
                                            </th>
                                            <td>
                                                <t t-esc="document.document_type_id.name"/>
                                            </td>
                                            <td>
                                                <a t-attf-href="/web/content/freight.house.shipment.document/#{document.id}/document_file?download=true"
                                                   class="text-decoration-none small">
                                                    <t t-if="document.document_file">
                                                        <i class="fa fa-download mr-1"/>
                                                        <span t-field="document.document_file_name"/>
                                                    </t>
                                                </a>
                                            </td>
                                            <td>
                                                <button class="btn py-0 px-1 fa fa-edit" type="button" data-toggle="modal" t-attf-data-target="#upload_document_modal_#{document.id}"/>
                                                <t t-call="ics_customer_portal_shipment_jobs.dialog_box">
                                                    <t t-set="dialog_id" t-value="'upload_document_modal_' + str(document.id)"/>
                                                    <t t-set="selected_document" t-value="document"/>
                                                </t>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                        <div role="tabpanel" class="tab-pane fade" id="cargo_details" >
                        <div class="row">
                            <t t-foreach="cargo_details" t-as="cargo">
                                <div class="mb-3 col-4">
                                    <strong><t t-esc="cargo"/>:
                                    </strong>
                                    <t t-esc="cargo_value"/>
                                </div>
                            </t>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

</odoo>
