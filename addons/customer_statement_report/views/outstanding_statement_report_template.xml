<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <template id="outstanding_customer_statement_main">
        <t t-call="web.html_container">
            <t t-if="not company">
                <t t-if="company_id">
                    <t t-set="company" t-value="company_id"/>
                </t>
                <t t-elif="o and 'company_id' in o and o.company_id.sudo()">
                    <t t-set="company" t-value="o.company_id.sudo()"/>
                </t>
                <t t-else="else">
                    <t t-set="company" t-value="res_company"/>
                </t>
            </t>
            <t t-set="report" t-value="docs[-1].with_context(qweb_report=True)"/>
            <t t-set="line_index" t-value="0"/>
            <t t-foreach="report._get_sections(options)" t-as="parent_section">
                <t t-set="section_lines" t-value="report.get_web_report_section_data(parent_section, options)"/>
                <t t-set="o" t-value="env['res.partner'].browse(parent_section.get('id'))"/>
                <t t-if="line_index == 0 and not parent_section.get('group_total')">
                    <t t-call="customer_statement_report.outstanding_customer_statement_line"/>
                    <t t-if="options.get('folded')">
                        <t t-set="line_index" t-value="line_index + 1"/>
                    </t>
                </t>
            </t>
        </t>
    </template>

    <template id="outstanding_customer_statement_line">
        <t t-if="not o" t-set="o" t-value="doc"/>
        <t t-call="web.external_layout">
            <div class="page" style="page-break-inside: avoid;">
                <h5 class="text-center font-weight-bolder"><span>
                    <t t-out="report._get_report_handler().get_title(report, options)"/>
                </span></h5>
                <div class="row mt-2">
                    <div class="col-4">
                        <div style="col-6">
                            <t t-if="not options.get('folded')">
                                <span t-out="o.name" class="font-weight-bold"/>
                                <address t-esc="o" t-options='{"widget": "contact", "fields": ["address", "mobile"], "no_marker": True}' />
                            </t>
                        </div>
                    </div>
                    <div class="col-3">
                        &amp;nbsp;
                    </div>
                    <div class="col-5">
                        <div>
                            <div class="row" name="currency">
                                <div class="col-5 text-right bg-dark">
                                    <span>CURRENCY:</span>
                                </div>
                                <div class="col-7 text-left">
                                    <span><b><t t-out="company.currency_id.display_name"/></b></span>
                                </div>
                            </div>
                            <div class="row" name="payment_term">
                                <div class="col-5 text-right bg-dark">
                                    <span>STANDARD TERMS:</span>
                                </div>
                                <div class="col-7 text-left">
                                    <span t-if="o.property_payment_term_id" t-field="o.property_payment_term_id.display_name" />
                                    <span t-else="">0</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-5 text-right bg-dark">
                                    <span>ITEMS LISTED TO:</span>
                                </div>
                                <div class="col-7 text-left">
                                    <span t-out="context_timestamp(datetime.datetime.now()).strftime('%d-%b-%Y')"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <table class="table table-sm o_main_table ics_report_main_table" style="font-size: 0.6rem">
                <t t-set="group_headers" t-value="options.get('report_header_groups', [])"/>
                <t t-set="headers" t-value="options.get('headers', [])"/>
                <t t-set="only_columns" t-value="report.column_ids.mapped('expression_label')"/>
                <thead>
                    <tr t-if="options.get('filter_date') and len(group_headers) &gt; 1">
                        <th t-foreach="group_headers" t-as="group_header" t-att-colspan="len(headers)" class="text-center p-2 bg-300">
                            <t t-out="group_headers[group_header].get('string')"/>
                        </th>
                    </tr>
                    <tr>
                        <t t-foreach="group_headers" t-as="group_header">
                            <t t-foreach="headers" t-as="header" t-key="header_key">
                                <th class="bg-300" t-if="header['expression_label'] in only_columns or (show_ageing and header['expression_label'] == 'ageing')">
                                    <span><t t-out="header['string']"/></span>
                                </th>
                            </t>
                        </t>
                    </tr>
                </thead>
                <tbody style="color: #000000;">
                    <t t-foreach="section_lines" t-as="line">
                        <t t-set="line_class" t-value="line.get('row_class', '')"/>
                        <tr t-attf-class="ics_report_base_line_level_{{line['level']}} {{line_class and line_class + ' bg-300' or ''}}">
                            <t t-foreach="group_headers" t-as="group_header">
                                <t t-foreach="headers" t-as="header" t-key="header">
                                    <td
                                        t-if="header['expression_label'] in only_columns or (show_ageing and header['expression_label'] == 'ageing')"
                                        t-attf-class="ics_column_value {{'o_price_total' if header['value_type'] == 'monetary' else ''}} {{header['value_type']}} ics_report_base_line_level_{{line['level']}} {{line['values'][group_header].get(header['expression_label'] + '_is_zero', '') and 'ics_zero_value' or ''}} {{header['hide_if_zero'] and 'ics_hide_zero' or ''}}">
                                        <span><t t-out="line['values'][group_header].get(header['expression_label'], '')"/></span>
                                    </td>
                                </t>
                            </t>
                        </tr>
                    </t>
                    <t t-set="section_data" t-value="report._get_report_handler()._get_section_ageing_data(report, section_lines, options, o.id)" />
                    <tr>
                        <td class="text-right border-top border-dark" t-att-colspan="(len(headers) -2)" t-if="show_ageing">
                            <span class="font-weight-bold">Overdue at statement date:</span>
                        </td>
                        <td class="text-right border-top border-dark" t-att-colspan="(len(headers) -3)" t-if="not show_ageing">
                            <span class="font-weight-bold">Overdue at statement date:</span>
                        </td>
                        <td class="text-right border-top border-dark nowrap">
                            <t t-out="section_data.get('total_os_amount')[1]"/>
                        </td>
                        <td class="border-top border-dark">&amp;nbsp;</td>
                        <td class="border-top border-dark">&amp;nbsp;</td>
                    </tr>
                    <tr>
                        <td class="font-weight-bold text-right" t-att-colspan="(len(headers) - 2)" t-if="show_ageing">
                            <span class="font-weight-bold">Current at statement date:</span>
                        </td>
                        <td class="font-weight-bold text-right" t-att-colspan="(len(headers) - 3)" t-if="not show_ageing">
                            <span class="font-weight-bold">Current at statement date:</span>
                        </td>
                        <td class="text-right nowrap">
                            <t t-out="section_data.get('total_current_amount')[1]"/>
                        </td>
                        <td class="">&amp;nbsp;</td>
                        <td class="">&amp;nbsp;</td>
                    </tr>
                    <tr>
                        <td class="font-weight-bold text-right border-top border-dark" t-att-colspan="(len(headers) -1)" t-if="show_ageing">
                            <div>
                                <span t-out="o.currency_id.with_context(lang=o.lang).amount_to_text(section_data.get('total_due_amount')[0])"/>
                                &amp;nbsp; TOTAL: &amp;nbsp;<t t-out="o.currency_id.display_name" />
                            </div>
                        </td>
                        <td class="font-weight-bold text-right border-top border-dark" t-att-colspan="(len(headers) -1)" t-if="not show_ageing">
                            <div>
                                <span t-out="o.currency_id.with_context(lang=o.lang).amount_to_text(section_data.get('total_due_amount')[0])"/>
                                &amp;nbsp; TOTAL: &amp;nbsp;<t t-out="o.currency_id.display_name" />
                            </div>
                        </td>
                        <td class="font-weight-bold text-right border-top border-dark o_price_total nowrap">
                            <t t-out="section_data.get('total_due_amount')[1]"/>
                        </td>
                        <td class="border-top border-dark">&amp;nbsp;</td>
                    </tr>
                </tbody>
            </table>
            <t t-if="show_ageing">
                <t t-call="customer_statement_report.outstanding_customer_statement_line_aging"/>
            </t>
            <t t-else="">
            </t>
            <t t-set="banks_by_currency" t-value="{}"/>
            <t t-set="banks" t-value="company.bank_ids.filtered(lambda l: l.visible_on_report)" />
            <div class="row" style="page-break-inside: avoid;font-size: 0.9rem;" t-if="banks">
                <div class="col-12 small">
                    <div class="pt-5 pb-2 text-decoration-underline font-weight-bold"><span>Bank Details</span></div>
                    <t t-set="currencies" t-value="banks.mapped('currency_id')" />
                    <t t-foreach="currencies" t-as="currency">
                        <t t-set="currency_banks" t-value="banks.filtered(lambda bank: bank.currency_id == currency)" />
                        <div class="font-weight-bold">Bank details (<t t-out="currency.name" />)</div>
                        <t t-foreach="currency_banks" t-as="bank">
                            <div class="mb-2">
                                <span>Beneficiary Name: <t t-out="bank.acc_holder_name or bank.partner_id.name"/></span><br/>
                                <span>Bank: <t t-out="bank.bank_id.name"/></span><br/>
                                <span>
                                    A/C No: &amp;nbsp; <t t-out="bank.acc_number"/>
                                    <t t-if="bank.bank_id.iban_number">
                                        &amp;nbsp; IBAN No: &amp;nbsp;<t t-out="bank.bank_id.iban_number"/>
                                    </t>
                                    <t t-if="bank.bank_id.bic">
                                        &amp;nbsp; Swift Code: &amp;nbsp;<t t-out="bank.bank_id.bic"/>
                                    </t>
                                </span>
                            </div>
                        </t>
                    </t>
                </div>
            </div>
            <div class="row" name="invoice_terms" style="page-break-inside: avoid;">
                <div class="col-12 small">
                    <div class="pt-5 text-decoration-underline font-weight-bold"><span>Terms &amp; Conditions</span></div>
                    <t t-raw="company.invoice_terms"/>
                </div>
            </div>
        </t>
    </template>

    <template id="outstanding_customer_statement_line_aging">
        <t t-if="show_ageing">
            <t t-set="ageing_data" t-value="section_data.get('ageing_data')" />

            <div style="page-break-inside: avoid;">
                <div class="row" style="page-break-inside: avoid;">
                    <div class="col-12">
                        <strong>Ageing: </strong>
                    </div>
                </div>
            </div>
            <table class="table table-sm" style="page-break-inside: avoid;">
                <t t-set="ageing_header_items" t-value="report._get_report_handler()._get_ageing_headers(options)"/>
                <thead class="bg-300">
                    <tr class="text-right">
                        <th class="text-center">Total O/S <t t-out="o.currency_id.display_name" /></th>
                        <th class="text-center"> &lt;= 0</th>
                        <t t-foreach="ageing_header_items" t-as="aging_header">
                            <th class="text-center">
                                <span t-out="aging_header[0]"/>
                            </th>
                        </t>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="text-center">
                            <t t-out="section_data.get('total_due_amount')[1]"/>
                        </td>
                        <td class="text-center">
                            <t t-out="section_data.get('total_current_amount')[1]"/>
                        </td>
                        <t t-foreach="ageing_header_items" t-as="aging_header">
                            <td class="text-center">
                                <t t-out="ageing_data.get(aging_header[0])[1]" />
                            </td>
                        </t>
                    </tr>
                </tbody>
            </table>
        </t>
    </template>
</odoo>
